<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VƒÉn h√≥a Giao th√¥ng Xanh - Tr∆∞·ªùng TH Nam H√†</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS (B·∫£n ƒë·ªì) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- T·∫£i Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Styles */
        .custom-div-icon { background: transparent; border: none; }
        .leaflet-popup-content-wrapper { border-radius: 0.5rem; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0.5rem; font-family: sans-serif; font-size: 0.875rem; }
        .cursor-crosshair { cursor: crosshair !important; }
        
        /* Rich Text Styles */
        .rte-content { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; }
        .rte-content h1 { font-size: 2em; font-weight: bold; margin: 0.67em 0; }
        .rte-content h2 { font-size: 1.5em; font-weight: bold; margin: 0.83em 0; }
        .rte-content p, .rte-content div { margin: 0.5em 0; }
        .rte-content ul { list-style-type: disc; padding-left: 40px; margin: 1em 0; }
        .rte-content ol { list-style-type: decimal; padding-left: 40px; margin: 1em 0; }
        .rte-content blockquote { margin: 1em 40px; padding-left: 10px; border-left: 4px solid #ccc; color: #666; }
        .rte-content img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Map, AlertTriangle, FileText, Megaphone, Shield, 
          Award, LogIn, Plus, Trash2, Save, Menu, X, Edit,
          Navigation, Info, User, Layout, MapPin, CheckSquare, XCircle,
          Eye, EyeOff, MousePointer2, Undo2, ArrowLeft, Calendar,
          Bold, Italic, Underline, Search, MessageSquare, CheckCircle, HelpCircle
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { 
          getFirestore, collection, addDoc, getDocs, 
          deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp, updateDoc 
        } from 'firebase/firestore';
        import { 
          getAuth, signInWithEmailAndPassword, signOut, 
          onAuthStateChanged 
        } from 'firebase/auth';

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) return (<div className="p-8 text-center text-red-600 bg-red-50 border border-red-200 rounded m-4"><h2 className="text-xl font-bold mb-2">ƒê√£ x·∫£y ra l·ªói!</h2><p className="text-sm">{this.state.error.toString()}</p><button onClick={() => window.location.reload()} className="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">T·∫£i l·∫°i trang</button></div>);
                return this.props.children;
            }
        }

        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyA7A_VxnEqlYMebteU76Om0FnrkVH8Pdl4",
          authDomain: "atgt-6c132.firebaseapp.com",
          projectId: "atgt-6c132",
          storageBucket: "atgt-6c132.firebasestorage.app",
          messagingSenderId: "386224446840",
          appId: "1:386224446840:web:1fbb428b3c4799260d7c8d",
          measurementId: "G-D6EZ3CFQRF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const MAP_LAYERS = [
            { id: 'A', label: 'Tr∆∞·ªùng TH Nam H√† (TT)', color: 'text-blue-700', icon: <MapPin className="w-4 h-4" /> },
            { id: 'B', label: 'Tuy·∫øn ƒë∆∞·ªùng HS ƒëi', color: 'text-gray-600', icon: <Navigation className="w-4 h-4" /> },
            { id: 'C', label: 'ƒêi·ªÉm Nguy c∆°/√ôn t·∫Øc', color: 'text-red-600', icon: <AlertTriangle className="w-4 h-4" /> },
            { id: 'D', label: 'Khu v·ª±c ƒê∆∞a ƒë√≥n An to√†n', color: 'text-green-600', icon: <Shield className="w-4 h-4" /> },
            { id: 'E', label: 'Ch·ªët tr·ª±c (CA/ƒêo√†n)', color: 'text-yellow-600', icon: <User className="w-4 h-4" /> },
        ];

        // --- Component: Header ---
        const Header = ({ setCurrentPage, user, onLogout }) => {
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const navItems = [
                { id: 'home', label: 'Trang ch·ªß' },
                { id: 'news', label: 'Tin t·ª©c' },
                { id: 'docs', label: 'VƒÉn b·∫£n' },
                { id: 'model', label: 'M√¥ h√¨nh' },
                { id: 'skills', label: 'K·ªπ nƒÉng' },
                { id: 'quiz', label: 'Tr·∫Øc nghi·ªám' }, // NEW
                { id: 'feedback', label: 'G√≥p √Ω' }, // NEW
                { id: 'map', label: 'B·∫£n ƒë·ªì' },
            ];
            return (
                <header className="bg-blue-800 text-white shadow-lg sticky top-0 z-50">
                <div className="container mx-auto px-4 py-3 flex justify-between items-center">
                    <div className="flex items-center space-x-3 cursor-pointer" onClick={() => setCurrentPage('home')}>
                        <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center border-2 border-red-500"><Shield className="text-blue-800 w-8 h-8" /></div>
                        <div><h1 className="font-bold text-lg md:text-xl uppercase leading-tight">VƒÉn h√≥a Giao th√¥ng Xanh</h1><p className="text-xs md:text-sm opacity-90">Tr∆∞·ªùng TH Nam H√† - H√† Tƒ©nh</p></div>
                    </div>
                    <nav className="hidden lg:flex space-x-1">
                        {navItems.map(item => (
                            <button key={item.id} onClick={() => setCurrentPage(item.id)} className="px-3 py-2 text-sm hover:bg-blue-700 rounded transition font-medium whitespace-nowrap">{item.label}</button>
                        ))}
                        {user ? <button onClick={onLogout} className="bg-red-500 px-3 py-2 rounded text-sm hover:bg-red-600 ml-2 flex items-center gap-1"><span className="font-bold">Admin</span></button> : <button onClick={() => setCurrentPage('login')} className="bg-yellow-500 text-blue-900 px-3 py-2 rounded text-sm hover:bg-yellow-400 ml-2 font-bold flex items-center gap-1 whitespace-nowrap"><LogIn className="w-4 h-4" /> ƒêƒÉng nh·∫≠p</button>}
                    </nav>
                    <button className="lg:hidden p-2" onClick={() => setIsMenuOpen(!isMenuOpen)}>{isMenuOpen ? <X /> : <Menu />}</button>
                </div>
                {isMenuOpen && (
                    <div className="lg:hidden bg-blue-900 p-4 space-y-2">
                    {navItems.map(item => (<button key={item.id} onClick={() => { setCurrentPage(item.id); setIsMenuOpen(false); }} className="block w-full text-left px-4 py-2 hover:bg-blue-800 rounded">{item.label}</button>))}
                    {user ? <button onClick={onLogout} className="block w-full text-left px-4 py-2 bg-red-600 rounded">ƒêƒÉng xu·∫•t (Admin)</button> : <button onClick={() => {setCurrentPage('login'); setIsMenuOpen(false);}} className="block w-full text-left px-4 py-2 bg-yellow-500 text-blue-900 rounded font-bold">ƒêƒÉng nh·∫≠p Qu·∫£n tr·ªã</button>}
                    </div>
                )}
                </header>
            );
        };

        // --- Rich Text Editor ---
        const SimpleRichTextEditor = ({ value, onChange }) => {
            const editorRef = useRef(null);
            useEffect(() => { if (editorRef.current) editorRef.current.innerHTML = value || ''; }, []);
            const execCmd = (command, val = null) => { document.execCommand(command, false, val); editorRef.current.focus(); };
            return (
                <div className="border rounded bg-white">
                    <div className="flex flex-wrap gap-2 p-2 border-b bg-gray-50">
                        <button type="button" onClick={() => execCmd('bold')} className="p-1 hover:bg-gray-200 rounded" title="In ƒë·∫≠m"><Bold className="w-4 h-4"/></button>
                        <button type="button" onClick={() => execCmd('italic')} className="p-1 hover:bg-gray-200 rounded" title="In nghi√™ng"><Italic className="w-4 h-4"/></button>
                        <button type="button" onClick={() => execCmd('underline')} className="p-1 hover:bg-gray-200 rounded" title="G·∫°ch ch√¢n"><Underline className="w-4 h-4"/></button>
                        <div className="h-6 w-px bg-gray-300 mx-1"></div>
                        <select onChange={(e) => execCmd('fontSize', e.target.value)} className="text-xs border rounded p-1" defaultValue="3"><option value="2">Nh·ªè</option><option value="3">V·ª´a</option><option value="4">L·ªõn</option><option value="6">Ti√™u ƒë·ªÅ</option></select>
                    </div>
                    <div ref={editorRef} contentEditable className="p-4 min-h-[200px] focus:outline-none rte-content" onInput={() => onChange(editorRef.current.innerHTML)} style={{ overflowY: 'auto' }}></div>
                </div>
            );
        };

        // --- Leaflet Map ---
        const LeafletMap = ({ markers, activeLayers, onMapClick, drawingData }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const layersRef = useRef([]);
            const drawingLayerRef = useRef(null);

            useEffect(() => { if (window.L && !mapInstanceRef.current) initMap(); }, []);

            const initMap = () => {
                if (!mapContainerRef.current || window.L === undefined) return;
                const map = window.L.map(mapContainerRef.current).setView([18.336241, 105.902037], 16);
                window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
                mapInstanceRef.current = map;
                updateLayers(map);
            };

            useEffect(() => {
                if (!mapInstanceRef.current) return;
                const map = mapInstanceRef.current;
                const clickHandler = (e) => { if (onMapClick) onMapClick({ lat: e.latlng.lat, lng: e.latlng.lng }); };
                if (onMapClick) { map.getContainer().classList.add('cursor-crosshair'); map.on('click', clickHandler); }
                else { map.getContainer().classList.remove('cursor-crosshair'); map.off('click', clickHandler); }
                return () => { map.off('click', clickHandler); };
            }, [onMapClick]);

            useEffect(() => {
                if (!mapInstanceRef.current || !window.L) return;
                const map = mapInstanceRef.current;
                if (drawingLayerRef.current) drawingLayerRef.current.forEach(l => map.removeLayer(l));
                drawingLayerRef.current = [];
                if (!drawingData) return;
                const { type, points } = drawingData;
                if (points && points.length > 0 && points.every(p => !isNaN(p[0]) && !isNaN(p[1]))) {
                    points.forEach(pt => {
                        const m = window.L.marker(pt, { icon: window.L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color: #ec4899; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>` }) }).addTo(map);
                        drawingLayerRef.current.push(m);
                    });
                    if (points.length > 1) {
                        const shape = type === 'polyline' ? window.L.polyline(points, { color: '#ec4899', dashArray: '5, 10', weight: 3 }) : window.L.polygon(points, { color: '#ec4899', dashArray: '5, 10', weight: 3, fillOpacity: 0.2 });
                        shape.addTo(map);
                        drawingLayerRef.current.push(shape);
                    }
                }
            }, [drawingData]);

            useEffect(() => { if (mapInstanceRef.current && window.L) updateLayers(mapInstanceRef.current); }, [markers, activeLayers]);

            const updateLayers = (map) => {
                layersRef.current.forEach(layer => map.removeLayer(layer));
                layersRef.current = [];
                markers.forEach(feature => {
                    if (activeLayers.includes(feature.type) && feature.isVisible !== false) {
                        try {
                            if (!feature.geometryType || feature.geometryType === 'point') {
                                const m = window.L.marker([feature.lat, feature.lng], { icon: window.L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color:${feature.type === 'C' ? 'red' : (feature.type === 'E' ? 'gold' : 'blue')}; width:14px; height:14px; border-radius:50%; border:2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>` }) }).bindPopup(feature.label).addTo(map);
                                layersRef.current.push(m);
                            } else if (feature.geometryType === 'polygon' && feature.coordinates) {
                                const p = window.L.polygon(feature.coordinates, { color: 'green', fillColor: '#4ade80', fillOpacity: 0.4, weight: 2 }).bindPopup(feature.label).addTo(map);
                                layersRef.current.push(p);
                            } else if (feature.geometryType === 'polyline' && feature.coordinates) {
                                const l = window.L.polyline(feature.coordinates, { color: '#4b5563', weight: 4, dashArray: '5, 10', opacity: 0.7 }).bindPopup(feature.label).addTo(map);
                                layersRef.current.push(l);
                            }
                        } catch(e) { console.warn("Skipping invalid marker", feature); }
                    }
                });
            };
            return <div ref={mapContainerRef} className="w-full h-96 z-0" />;
        };

        // --- NEW FEATURE: TRAFFIC QUIZ ---
        const TrafficQuiz = () => {
            const questions = [
                { q: "Khi g·∫∑p ƒë√®n t√≠n hi·ªáu giao th√¥ng m√†u ƒë·ªè, em ph·∫£i l√†m g√¨?", a: ["ƒêi ch·∫≠m l·∫°i", "D·ª´ng l·∫°i tr∆∞·ªõc v·∫°ch d·ª´ng", "Ti·∫øp t·ª•c ƒëi n·∫øu v·∫Øng", "R·∫Ω ph·∫£i ngay l·∫≠p t·ª©c"], correct: 1 },
                { q: "Bi·ªÉn b√°o n√†o c·∫•m ƒëi ng∆∞·ª£c chi·ªÅu?", a: ["Bi·ªÉn h√¨nh tr√≤n ƒë·ªè c√≥ g·∫°ch ch√©o", "Bi·ªÉn h√¨nh tr√≤n ƒë·ªè c√≥ g·∫°ch ngang tr·∫Øng", "Bi·ªÉn h√¨nh tam gi√°c v√†ng", "Bi·ªÉn h√¨nh vu√¥ng xanh"], correct: 1 },
                { q: "Tr·∫ª em d∆∞·ªõi bao nhi√™u tu·ªïi kh√¥ng ƒë∆∞·ª£c ƒëi xe ƒë·∫°p ƒëi·ªán?", a: ["16 tu·ªïi", "14 tu·ªïi", "12 tu·ªïi", "10 tu·ªïi"], correct: 0 },
                { q: "Khi ng·ªìi sau xe m√°y, em c·∫ßn l√†m g√¨ ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n?", a: ["ƒê·ªôi m≈© b·∫£o hi·ªÉm c√†i quai ƒë√∫ng quy c√°ch", "C·∫ßm √¥ che n·∫Øng", "ƒê·ª©ng l√™n y√™n xe", "Kh√¥ng c·∫ßn l√†m g√¨ c·∫£"], correct: 0 },
                { q: "V·∫°ch k·∫ª ƒë∆∞·ªùng d√†nh cho ng∆∞·ªùi ƒëi b·ªô c√≥ h√¨nh d√°ng nh∆∞ th·∫ø n√†o?", a: ["V·∫°ch ƒë·ª©t qu√£ng", "V·∫°ch li·ªÅn m√†u v√†ng", "C√°c v·∫°ch tr·∫Øng song song (v·∫°ch ng·ª±a v·∫±n)", "H√¨nh thoi"], correct: 2 },
            ];
            const [currentQ, setCurrentQ] = useState(0);
            const [score, setScore] = useState(0);
            const [showScore, setShowScore] = useState(false);
            const [selectedAns, setSelectedAns] = useState(null);

            const handleAnswer = (idx) => {
                setSelectedAns(idx);
                if (idx === questions[currentQ].correct) setScore(score + 1);
                setTimeout(() => {
                    const nextQ = currentQ + 1;
                    if (nextQ < questions.length) { setCurrentQ(nextQ); setSelectedAns(null); } 
                    else setShowScore(true);
                }, 1000);
            };

            const restart = () => { setScore(0); setCurrentQ(0); setShowScore(false); setSelectedAns(null); };

            return (
                <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 animate-fade-in">
                    <h2 className="text-2xl font-bold text-blue-800 mb-6 text-center flex items-center justify-center gap-2"><Award className="text-yellow-500"/> Th·ª≠ t√†i An to√†n Giao th√¥ng</h2>
                    {showScore ? (
                        <div className="text-center space-y-4">
                            <div className="text-6xl mb-4">{score >= 4 ? 'üèÜ' : score >= 3 ? 'üòä' : 'üìö'}</div>
                            <h3 className="text-xl font-bold">B·∫°n tr·∫£ l·ªùi ƒë√∫ng {score} / {questions.length} c√¢u!</h3>
                            <p className="text-gray-600">{score >= 4 ? "Tuy·ªát v·ªùi! B·∫°n l√† chi·∫øn sƒ© giao th√¥ng t√≠ hon!" : "H√£y √¥n l·∫°i ki·∫øn th·ª©c nh√©!"}</p>
                            <button onClick={restart} className="bg-blue-600 text-white px-6 py-2 rounded-full hover:bg-blue-700 font-bold">L√†m l·∫°i</button>
                        </div>
                    ) : (
                        <div>
                            <div className="mb-4 flex justify-between text-sm text-gray-500"><span>C√¢u h·ªèi {currentQ + 1}/{questions.length}</span><span>ƒêi·ªÉm: {score}</span></div>
                            <div className="mb-6"><h3 className="text-lg font-bold text-gray-800">{questions[currentQ].q}</h3></div>
                            <div className="space-y-3">
                                {questions[currentQ].a.map((ans, idx) => (
                                    <button key={idx} onClick={() => handleAnswer(idx)} disabled={selectedAns !== null}
                                        className={`w-full text-left p-4 rounded border transition ${selectedAns !== null ? (idx === questions[currentQ].correct ? 'bg-green-100 border-green-500 text-green-800' : idx === selectedAns ? 'bg-red-100 border-red-500 text-red-800' : 'bg-gray-50') : 'hover:bg-blue-50 border-gray-200'}`}>
                                        {ans}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- NEW FEATURE: FEEDBACK FORM ---
        const FeedbackForm = () => {
            const [name, setName] = useState('');
            const [content, setContent] = useState('');
            const [status, setStatus] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setStatus('sending');
                try {
                    await addDoc(collection(db, 'feedback'), {
                        name: name || '·∫®n danh',
                        content,
                        createdAt: serverTimestamp(),
                        isRead: false
                    });
                    setStatus('success'); setName(''); setContent('');
                } catch (err) { setStatus('error'); }
            };

            return (
                <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 animate-fade-in">
                    <h2 className="text-2xl font-bold text-blue-800 mb-4 flex items-center gap-2"><MessageSquare /> G√≥c √ù ki·∫øn - Ph·∫£n √°nh</h2>
                    <p className="text-gray-600 mb-6 text-sm">Ph·ª• huynh v√† h·ªçc sinh c√≥ th·ªÉ g·ª≠i √Ω ki·∫øn ƒë√≥ng g√≥p, b√°o c√°o ƒëi·ªÉm ƒëen ho·∫∑c ƒë·ªÅ xu·∫•t gi·∫£i ph√°p ATGT t·∫°i ƒë√¢y. (C√≥ th·ªÉ ·∫©n danh)</p>
                    {status === 'success' ? (
                        <div className="bg-green-50 text-green-700 p-4 rounded text-center"><CheckCircle className="inline w-8 h-8 mb-2"/><p>C·∫£m ∆°n b·∫°n! √ù ki·∫øn ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn Ban qu·∫£n tr·ªã.</p><button onClick={() => setStatus('')} className="mt-2 text-sm underline">G·ª≠i √Ω ki·∫øn kh√°c</button></div>
                    ) : (
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block font-bold mb-1">H·ªç v√† t√™n (T√πy ch·ªçn)</label><input className="w-full border p-2 rounded" value={name} onChange={e=>setName(e.target.value)} placeholder="ƒê·ªÉ tr·ªëng n·∫øu mu·ªën ·∫©n danh"/></div>
                            <div><label className="block font-bold mb-1">N·ªôi dung ph·∫£n √°nh *</label><textarea required className="w-full border p-2 rounded h-32" value={content} onChange={e=>setContent(e.target.value)} placeholder="VD: C·ªëng tho√°t n∆∞·ªõc c·ªïng sau b·ªã m·∫•t n·∫Øp..."></textarea></div>
                            <button disabled={status === 'sending'} className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-bold w-full">{status === 'sending' ? 'ƒêang g·ª≠i...' : 'G·ª≠i √ù ki·∫øn'}</button>
                            {status === 'error' && <p className="text-red-500 text-center">L·ªói khi g·ª≠i. Vui l√≤ng th·ª≠ l·∫°i.</p>}
                        </form>
                    )}
                </div>
            );
        };

        // --- Interactive Map Container ---
        const InteractiveMap = ({ isAdmin, onMapClick, drawingData }) => {
            const [activeLayers, setActiveLayers] = useState(['A', 'B', 'C', 'D', 'E']);
            const [parentMode, setParentMode] = useState(false);
            const [markers, setMarkers] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!db) { setLoading(false); return; }
                const q = query(collection(db, 'map_markers'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMarkers(data.length ? data : []);
                    setLoading(false);
                }, (error) => { console.error("L·ªói t·∫£i b·∫£n ƒë·ªì:", error); setLoading(false); });
                return () => unsubscribe();
            }, []);

            const toggleLayer = (id) => activeLayers.includes(id) ? setActiveLayers(activeLayers.filter(l => l !== id)) : setActiveLayers([...activeLayers, id]);
            const toggleParentMode = () => { setParentMode(!parentMode); setActiveLayers(!parentMode ? ['C', 'D'] : ['A', 'B', 'C', 'D', 'E']); };

            return (
                <div className="bg-white p-4 rounded-lg shadow-md">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <div><h2 className="text-2xl font-bold text-blue-800 flex items-center gap-2"><Map className="w-6 h-6" /> B·∫£n ƒë·ªì Giao th√¥ng s·ªë (GIS)</h2><p className="text-sm text-gray-500">D·ªØ li·ªáu th·ª±c t·∫ø khu v·ª±c Ph∆∞·ªùng Th√†nh Sen - OpenStreetMap</p></div>
                        <div className="flex gap-2">
                            {isAdmin && <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded flex items-center animate-pulse"><MousePointer2 className="w-3 h-3 mr-1"/> Ch·ªçn ƒëi·ªÉm</span>}
                            <button onClick={toggleParentMode} className={`px-4 py-2 rounded-full font-bold text-sm transition ${parentMode ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'}`}>{parentMode ? 'Ch·∫ø ƒë·ªô Ph·ª• huynh' : 'Ch·∫ø ƒë·ªô Ph·ª• huynh'}</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div className="lg:col-span-1 space-y-3 bg-slate-50 p-4 rounded border">
                            <h3 className="font-bold text-gray-700">L·ªõp d·ªØ li·ªáu (Layers)</h3>
                            {MAP_LAYERS.map(layer => (<div key={layer.id} className="flex items-center gap-2 cursor-pointer" onClick={() => toggleLayer(layer.id)}><div className={`w-5 h-5 rounded border flex items-center justify-center ${activeLayers.includes(layer.id) ? 'bg-blue-600 border-blue-600' : 'bg-white border-gray-400'}`}>{activeLayers.includes(layer.id) && <CheckSquare className="w-3 h-3 text-white" />}</div><span className={`text-sm ${layer.color} font-medium flex items-center gap-2`}>{layer.icon} {layer.label}</span></div>))}
                            <div className="mt-6 border-t pt-4"><h3 className="font-bold text-gray-700 mb-2">Ch√∫ th√≠ch</h3><div className="text-xs space-y-2 text-gray-600"><div className="flex items-center gap-2"><div className="w-3 h-3 bg-green-400 opacity-50 border border-green-600"></div> V√πng an to√†n</div><div className="flex items-center gap-2"><div className="w-6 h-1 bg-gray-500 border-t border-dashed"></div> Tuy·∫øn ƒë∆∞·ªùng HS</div><div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-red-600 border-2 border-white shadow"></div> ƒêi·ªÉm ƒëen/√ôn t·∫Øc</div>{isAdmin && <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-pink-500 border-2 border-white shadow animate-pulse"></div> ƒêang v·∫Ω/ch·ªçn</div>}</div></div>
                        </div>
                        <div className="lg:col-span-3 bg-blue-50 h-96 rounded-xl border-2 border-blue-200 relative overflow-hidden group z-0">{loading ? <div className="absolute inset-0 flex items-center justify-center">ƒêang t·∫£i b·∫£n ƒë·ªì...</div> : <LeafletMap markers={markers} activeLayers={activeLayers} onMapClick={onMapClick} drawingData={drawingData} />}</div>
                    </div>
                </div>
            );
        };

        // --- Admin Dashboard ---
        const AdminDashboard = () => {
            const [activeTab, setActiveTab] = useState('news'); 
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');
            const [backgroundImage, setBackgroundImage] = useState('');
            const [category, setCategory] = useState('Tin t·ª©c');
            const [status, setStatus] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [adminPosts, setAdminPosts] = useState([]);
            const [adminDocs, setAdminDocs] = useState([]);
            const [mapItems, setMapItems] = useState([]);
            const [feedbacks, setFeedbacks] = useState([]);
            const [geometryType, setGeometryType] = useState('point'); 
            const [lat, setLat] = useState('');
            const [lng, setLng] = useState('');
            const [coordString, setCoordString] = useState('');
            const [markerType, setMarkerType] = useState('C');
            const [isVisible, setIsVisible] = useState(true); 

            useEffect(() => {
                let unsubscribe = () => {};
                if (activeTab === 'news') { const q = query(collection(db, 'news'), orderBy('createdAt', 'desc')); unsubscribe = onSnapshot(q, (s) => setAdminPosts(s.docs.map(d => ({id: d.id, ...d.data()})))); }
                else if (activeTab === 'docs') { const q = query(collection(db, 'documents'), orderBy('createdAt', 'desc')); unsubscribe = onSnapshot(q, (s) => setAdminDocs(s.docs.map(d => ({id: d.id, ...d.data()})))); }
                else if (activeTab === 'map') { const q = query(collection(db, 'map_markers'), orderBy('createdAt', 'desc')); unsubscribe = onSnapshot(q, (s) => setMapItems(s.docs.map(d => ({id: d.id, ...d.data()})))); }
                else if (activeTab === 'feedback') { const q = query(collection(db, 'feedback'), orderBy('createdAt', 'desc')); unsubscribe = onSnapshot(q, (s) => setFeedbacks(s.docs.map(d => ({id: d.id, ...d.data()})))); }
                return () => unsubscribe();
            }, [activeTab]);

            const resetForm = () => { setTitle(''); setContent(''); setBackgroundImage(''); setCategory('Tin t·ª©c'); setLat(''); setLng(''); setCoordString(''); setIsVisible(true); setEditingId(null); };
            const handleEdit = (item) => {
                setEditingId(item.id); setTitle(item.title); setCategory(item.category || 'Tin t·ª©c');
                if (activeTab === 'map') {
                    setMarkerType(item.type); setGeometryType(item.geometryType || 'point'); setIsVisible(item.isVisible !== false);
                    if (item.geometryType === 'point' || !item.geometryType) { setLat(item.lat); setLng(item.lng); setCoordString(''); }
                    else { setCoordString(item.coordinates.map(p => p.join(',')).join('; ')); setLat(''); setLng(''); }
                } else { setContent(item.content); setBackgroundImage(item.backgroundImage || ''); }
            };
            const handleMapClick = (coords) => {
                if (activeTab !== 'map') return;
                if (geometryType === 'point') { setLat(coords.lat.toFixed(6)); setLng(coords.lng.toFixed(6)); }
                else { const pt = `${coords.lat.toFixed(6)},${coords.lng.toFixed(6)}`; setCoordString(prev => prev ? `${prev}; ${pt}` : pt); }
            };
            const handleUndoPoint = () => { if (!coordString) return; const parts = coordString.split(';').map(s => s.trim()); parts.pop(); setCoordString(parts.join('; ')); };
            const toggleMapItemVisibility = async (item) => { try { await updateDoc(doc(db, 'map_markers', item.id), { isVisible: item.isVisible === false ? true : false }); } catch (err) { alert("L·ªói: " + err.message); } };
            const handleDelete = async (col, id) => { if(window.confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) { try { await deleteDoc(doc(db, col, id)); if (editingId === id) resetForm(); } catch(err) { alert("L·ªói: " + err.message); } } };
            const handleSubmit = async (e) => {
                e.preventDefault(); setStatus('ƒêang x·ª≠ l√Ω...');
                try {
                    let col = activeTab === 'map' ? 'map_markers' : (activeTab === 'news' ? 'news' : 'documents');
                    let data = activeTab === 'map' ? { label: title, type: markerType, geometryType, isVisible } : { title, content, backgroundImage, category };
                    if (activeTab === 'map') {
                        if (geometryType === 'point') { data.lat = parseFloat(lat); data.lng = parseFloat(lng); }
                        else { data.coordinates = coordString.split(';').map(p => { const [la, lo] = p.trim().split(','); return [parseFloat(la), parseFloat(lo)]; }); }
                    }
                    if (!editingId) data.createdAt = serverTimestamp();
                    editingId ? await updateDoc(doc(db, col, editingId), data) : await addDoc(collection(db, col), data);
                    setStatus(editingId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m m·ªõi th√†nh c√¥ng!'); resetForm(); setTimeout(() => setStatus(''), 3000);
                } catch (err) { setStatus('L·ªói: ' + err.message); }
            };

            const drawingData = useMemo(() => {
                if (activeTab !== 'map') return null;
                if (geometryType === 'point') return (lat && lng && !isNaN(lat) && !isNaN(lng)) ? { type: 'point', points: [[parseFloat(lat), parseFloat(lng)]] } : null;
                if (!coordString) return null;
                try {
                    const points = coordString.split(';').map(p => { const [la, lo] = p.trim().split(','); return [parseFloat(la), parseFloat(lo)]; }).filter(p => !isNaN(p[0]) && !isNaN(p[1]));
                    return { type: geometryType, points };
                } catch(e) { return null; }
            }, [activeTab, geometryType, lat, lng, coordString]);

            return (
                <div className="bg-white p-6 rounded shadow-lg mt-4">
                    <h2 className="text-2xl font-bold text-red-700 mb-4 flex items-center gap-2"><Layout className="w-6 h-6" /> Qu·∫£n tr·ªã H·ªá th·ªëng</h2>
                    <div className="flex space-x-2 mb-6 border-b pb-2 overflow-x-auto">
                        <button onClick={() => {setActiveTab('news'); resetForm();}} className={`px-4 py-2 rounded whitespace-nowrap ${activeTab === 'news' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>Tin t·ª©c</button>
                        <button onClick={() => {setActiveTab('docs'); resetForm();}} className={`px-4 py-2 rounded whitespace-nowrap ${activeTab === 'docs' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>VƒÉn b·∫£n</button>
                        <button onClick={() => {setActiveTab('map'); resetForm();}} className={`px-4 py-2 rounded whitespace-nowrap ${activeTab === 'map' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>B·∫£n ƒë·ªì</button>
                        <button onClick={() => {setActiveTab('feedback'); resetForm();}} className={`px-4 py-2 rounded whitespace-nowrap ${activeTab === 'feedback' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>√ù ki·∫øn</button>
                    </div>
                    {activeTab === 'feedback' && (
                        <div className="space-y-4">
                            <div className="bg-gray-100 p-3 font-bold text-gray-700 flex justify-between"><span>Danh s√°ch √ù ki·∫øn</span><span className="text-xs bg-gray-200 px-2 py-1 rounded">{feedbacks.length} m·ª•c</span></div>
                            <div className="max-h-96 overflow-y-auto space-y-2">
                                {feedbacks.map(fb => (
                                    <div key={fb.id} className="bg-white border p-4 rounded shadow-sm">
                                        <div className="flex justify-between mb-2"><span className="font-bold text-blue-800">{fb.name}</span><span className="text-xs text-gray-500">{fb.createdAt ? new Date(fb.createdAt.seconds*1000).toLocaleString() : ''}</span></div>
                                        <p className="text-gray-700">{fb.content}</p>
                                    </div>
                                ))}
                                {feedbacks.length === 0 && <p className="text-center text-gray-500 py-4">Ch∆∞a c√≥ √Ω ki·∫øn n√†o.</p>}
                            </div>
                        </div>
                    )}
                    {activeTab === 'map' && (
                        <div className="space-y-6">
                            <div className="bg-blue-50 p-2 rounded border border-blue-200"><p className="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2"><MousePointer2 className="w-4 h-4"/> Click b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm/v·∫Ω</p><InteractiveMap isAdmin={true} onMapClick={handleMapClick} drawingData={drawingData} /></div>
                            <form onSubmit={handleSubmit} className="bg-yellow-50 p-4 rounded border border-yellow-200 space-y-4">
                                <h3 className="font-bold text-yellow-800 border-b border-yellow-200 pb-2">{editingId ? 'S·ª≠a ƒë·ªëi t∆∞·ª£ng' : 'Th√™m ƒë·ªëi t∆∞·ª£ng m·ªõi'}</h3>
                                <div><label className="block font-bold mb-1 text-sm">T√™n hi·ªÉn th·ªã</label><input required value={title} onChange={e => setTitle(e.target.value)} className="w-full border p-2 rounded" /></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block font-bold mb-1 text-sm">Lo·∫°i h√¨nh</label><select value={geometryType} onChange={e => {setGeometryType(e.target.value); setCoordString(''); setLat(''); setLng('');}} className="w-full border p-2 rounded"><option value="point">ƒêi·ªÉm</option><option value="polyline">ƒê∆∞·ªùng</option><option value="polygon">V√πng</option></select></div>
                                    <div><label className="block font-bold mb-1 text-sm">L·ªõp</label><select value={markerType} onChange={e => setMarkerType(e.target.value)} className="w-full border p-2 rounded"><option value="A">Tr∆∞·ªùng h·ªçc</option><option value="B">Tuy·∫øn ƒë∆∞·ªùng</option><option value="C">ƒêi·ªÉm nguy c∆°</option><option value="D">V√πng an to√†n</option><option value="E">Ch·ªët tr·ª±c</option></select></div>
                                </div>
                                {geometryType === 'point' ? (
                                    <div className="grid grid-cols-2 gap-4 bg-white p-3 rounded border"><div><label className="block font-bold mb-1 text-sm">Vƒ© ƒë·ªô</label><input required type="number" step="any" value={lat} onChange={e => setLat(e.target.value)} className="w-full border p-2 rounded bg-gray-50" /></div><div><label className="block font-bold mb-1 text-sm">Kinh ƒë·ªô</label><input required type="number" step="any" value={lng} onChange={e => setLng(e.target.value)} className="w-full border p-2 rounded bg-gray-50" /></div></div>
                                ) : (
                                    <div><div className="flex justify-between items-center mb-1"><label className="block font-bold text-sm">Danh s√°ch t·ªça ƒë·ªô</label>{coordString && <button type="button" onClick={handleUndoPoint} className="text-xs flex items-center gap-1 bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200"><Undo2 className="w-3 h-3"/> X√≥a ƒëi·ªÉm cu·ªëi</button>}</div><textarea required value={coordString} onChange={e => setCoordString(e.target.value)} className="w-full border p-2 rounded h-20 font-mono text-xs" /></div>
                                )}
                                <div className="flex items-center gap-2 mb-2"><input type="checkbox" checked={isVisible} onChange={e => setIsVisible(e.target.checked)} className="w-4 h-4 text-blue-600" /><label className="text-sm font-bold text-gray-700">Hi·ªÉn th·ªã</label></div>
                                <div className="flex gap-2"><button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded flex items-center gap-2 font-bold w-full justify-center">{editingId ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>{editingId && <button type="button" onClick={resetForm} className="bg-gray-500 text-white px-4 py-2 rounded">H·ªßy</button>}</div>
                            </form>
                            <div className="bg-white border rounded-lg overflow-hidden"><div className="bg-gray-100 p-3 font-bold text-gray-700 flex justify-between"><span>Danh s√°ch</span><span className="text-xs bg-gray-200 px-2 py-1 rounded">{mapItems.length} m·ª•c</span></div><div className="max-h-60 overflow-y-auto">{mapItems.map(item => (<div key={item.id} className="p-3 border-b flex justify-between items-center hover:bg-gray-50 text-sm group"><div className="flex items-center gap-3"><button onClick={() => toggleMapItemVisibility(item)} className={`p-1 rounded-full ${item.isVisible !== false ? 'bg-green-100 text-green-600' : 'bg-gray-200 text-gray-400'}`}>{item.isVisible !== false ? <Eye className="w-4 h-4" /> : <EyeOff className="w-4 h-4" />}</button><div><span className={`font-bold block ${item.isVisible === false ? 'opacity-50 line-through' : ''}`}>{item.label}</span><span className="text-xs bg-blue-100 text-blue-800 px-1 rounded">Layer {item.type}</span></div></div><div className="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100"><button onClick={() => handleEdit(item)} className="text-blue-600"><Edit className="w-4 h-4" /></button><button onClick={() => handleDelete('map_markers', item.id)} className="text-red-500"><Trash2 className="w-4 h-4" /></button></div></div>))}</div></div>
                        </div>
                    )}
                    {activeTab === 'news' && (
                        <div className="space-y-6">
                            <form onSubmit={handleSubmit} className="bg-blue-50 p-4 rounded border border-blue-200 space-y-4">
                                <h3 className="font-bold text-blue-800 border-b border-blue-200 pb-2">{editingId ? 'S·ª≠a tin t·ª©c' : 'Th√™m tin t·ª©c m·ªõi'}</h3>
                                <div><label className="block font-bold mb-1">Ti√™u ƒë·ªÅ</label><input required value={title} onChange={e => setTitle(e.target.value)} className="w-full border p-2 rounded" /></div>
                                <div><label className="block font-bold mb-1">Link ·∫¢nh n·ªÅn (URL)</label><input value={backgroundImage} onChange={e => setBackgroundImage(e.target.value)} className="w-full border p-2 rounded" placeholder="https://example.com/image.jpg" /></div>
                                <div><label className="block font-bold mb-1">Chuy√™n m·ª•c</label><select value={category} onChange={e => setCategory(e.target.value)} className="w-full border p-2 rounded"><option>Tin t·ª©c</option><option>G∆∞∆°ng ƒëi·ªÉn h√¨nh</option><option>K·ªπ nƒÉng</option><option>C·ªïng tr∆∞·ªùng</option><option>G√≥c h·ªçc sinh</option><option>G√≥c ph·ª• huynh</option></select></div>
                                <div><label className="block font-bold mb-1">N·ªôi dung</label><SimpleRichTextEditor key={editingId || 'new'} value={content} onChange={setContent} /></div>
                                <div className="flex gap-2"><button type="submit" className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded flex items-center gap-2 font-bold"><Save className="w-4 h-4" /> {editingId ? 'C·∫≠p nh·∫≠t' : 'ƒêƒÉng b√†i'}</button>{editingId && <button type="button" onClick={resetForm} className="bg-gray-500 text-white px-4 py-2 rounded">H·ªßy</button>}</div>
                            </form>
                            <div className="bg-white border rounded-lg overflow-hidden"><div className="bg-gray-100 p-3 font-bold text-gray-700">Danh s√°ch</div><div className="max-h-80 overflow-y-auto">{adminPosts.map(post => (<div key={post.id} className="p-3 border-b flex justify-between hover:bg-gray-50 group"><div className="flex gap-3">{post.backgroundImage && <img src={post.backgroundImage} className="w-12 h-12 object-cover rounded" alt="thumb" />}<div><span className="font-bold block">{post.title}</span><span className="text-xs bg-gray-200 px-2 rounded">{post.category}</span></div></div><div className="flex gap-2 opacity-0 group-hover:opacity-100"><button onClick={() => handleEdit(post)} className="text-blue-600"><Edit className="w-4 h-4"/></button><button onClick={() => handleDelete('news', post.id)} className="text-red-500"><Trash2 className="w-4 h-4"/></button></div></div>))}</div></div>
                        </div>
                    )}
                    {activeTab === 'docs' && (
                        <div className="space-y-6">
                            <form onSubmit={handleSubmit} className="bg-blue-50 p-4 rounded border border-blue-200 space-y-4">
                                <h3 className="font-bold text-blue-800 border-b border-blue-200 pb-2">{editingId ? 'S·ª≠a vƒÉn b·∫£n' : 'Th√™m vƒÉn b·∫£n m·ªõi'}</h3>
                                <div><label className="block font-bold mb-1">T√™n vƒÉn b·∫£n</label><input required value={title} onChange={e => setTitle(e.target.value)} className="w-full border p-2 rounded" /></div>
                                <div><label className="block font-bold mb-1">Lo·∫°i</label><select value={category} onChange={e => setCategory(e.target.value)} className="w-full border p-2 rounded"><option>VƒÉn b·∫£n n·ªôi b·ªô</option><option>VƒÉn b·∫£n ph√°p lu·∫≠t</option><option>M·∫´u cam k·∫øt</option></select></div>
                                <div><label className="block font-bold mb-1">Link t·∫£i</label><input required value={content} onChange={e => setContent(e.target.value)} className="w-full border p-2 rounded" /></div>
                                <div className="flex gap-2"><button type="submit" className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded flex items-center gap-2 font-bold"><Save className="w-4 h-4" /> {editingId ? 'C·∫≠p nh·∫≠t' : 'L∆∞u'}</button>{editingId && <button type="button" onClick={resetForm} className="bg-gray-500 text-white px-4 py-2 rounded">H·ªßy</button>}</div>
                            </form>
                            <div className="bg-white border rounded-lg overflow-hidden"><div className="bg-gray-100 p-3 font-bold text-gray-700">Danh s√°ch</div><div className="max-h-80 overflow-y-auto">{adminDocs.map(doc => (<div key={doc.id} className="p-3 border-b flex justify-between hover:bg-gray-50 group"><div><span className="font-bold block">{doc.title}</span><span className="text-xs bg-gray-200 px-2 rounded">{doc.category}</span></div><div className="flex gap-2 opacity-0 group-hover:opacity-100"><button onClick={() => handleEdit(doc)} className="text-blue-600"><Edit className="w-4 h-4"/></button><button onClick={() => handleDelete('documents', doc.id)} className="text-red-500"><Trash2 className="w-4 h-4"/></button></div></div>))}</div></div>
                        </div>
                    )}
                    {status && <p className="mt-4 text-blue-600 font-bold animate-pulse text-center bg-blue-50 p-2 rounded">{status}</p>}
                </div>
            );
        };

        const NewsList = ({ categoryFilter }) => {
            const [posts, setPosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedPost, setSelectedPost] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [visibleCount, setVisibleCount] = useState(6);

            useEffect(() => { const q = query(collection(db, 'news'), orderBy('createdAt', 'desc')); const unsubscribe = onSnapshot(q, (s) => { setPosts(s.docs.map(d => ({ id: d.id, ...d.data() }))); setLoading(false); }); return () => unsubscribe(); }, []);
            
            const filteredPosts = posts.filter(p => 
                (!categoryFilter || p.category === categoryFilter) && 
                (!searchTerm || p.title.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            const displayedPosts = filteredPosts.slice(0, visibleCount);

            if (selectedPost) {
                return (
                    <div className="bg-white rounded-lg shadow-lg overflow-hidden animate-fade-in">
                        <div className="p-4 border-b flex items-center gap-2 bg-gray-50"><button onClick={() => setSelectedPost(null)} className="flex items-center gap-1 text-blue-600 font-bold hover:bg-blue-100 px-3 py-1 rounded"><ArrowLeft className="w-4 h-4" /> Quay l·∫°i</button><span className="text-gray-400">|</span><span className="text-sm text-gray-600 uppercase font-bold">{selectedPost.category}</span></div>
                        {selectedPost.backgroundImage && <div className="w-full h-64 bg-gray-200"><img src={selectedPost.backgroundImage} alt="Cover" className="w-full h-full object-cover" /></div>}
                        <div className="p-6 md:p-8"><h1 className="text-3xl font-bold text-gray-800 mb-4">{selectedPost.title}</h1><div className="flex items-center gap-2 text-sm text-gray-500 mb-6"><Calendar className="w-4 h-4" /> {selectedPost.createdAt ? new Date(selectedPost.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'V·ª´a xong'}</div><div className="rte-content text-gray-800 leading-relaxed" dangerouslySetInnerHTML={{ __html: selectedPost.content }} /></div>
                    </div>
                );
            }
            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <h2 className="text-2xl font-bold border-l-4 border-red-500 pl-3 text-gray-800 uppercase">{categoryFilter || 'Tin t·ª©c & S·ª± ki·ªán'}</h2>
                        <div className="relative">
                            <input type="text" placeholder="T√¨m ki·∫øm tin..." className="pl-9 pr-4 py-2 border rounded-full text-sm w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-blue-500" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>
                            <Search className="w-4 h-4 absolute left-3 top-2.5 text-gray-400"/>
                        </div>
                    </div>
                    {loading ? <p>ƒêang t·∫£i...</p> : (
                        <div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {displayedPosts.length > 0 ? displayedPosts.map(post => (
                                    <div key={post.id} className="bg-white rounded shadow hover:shadow-lg transition overflow-hidden flex flex-col h-full">
                                        <div className="h-48 bg-gray-200 flex items-center justify-center text-gray-400 relative">{post.backgroundImage ? <img src={post.backgroundImage} alt={post.title} className="w-full h-full object-cover" /> : <Megaphone className="w-12 h-12" />}<span className="absolute top-2 left-2 bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded uppercase opacity-90">{post.category}</span></div>
                                        <div className="p-4 flex-1 flex flex-col"><h3 className="font-bold text-lg mb-2 line-clamp-2 hover:text-blue-700 cursor-pointer" onClick={() => setSelectedPost(post)}>{post.title}</h3><p className="text-gray-600 text-sm line-clamp-3 mb-4 flex-1">{post.content ? post.content.replace(/<[^>]+>/g, '').substring(0, 120) + '...' : ''}</p><button onClick={() => setSelectedPost(post)} className="text-blue-600 text-sm font-bold hover:underline mt-auto self-start flex items-center gap-1">Xem chi ti·∫øt &rarr;</button></div>
                                    </div>
                                )) : <p className="text-gray-500 col-span-3">Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o.</p>}
                            </div>
                            {filteredPosts.length > visibleCount && (
                                <div className="text-center mt-8">
                                    <button onClick={() => setVisibleCount(prev => prev + 6)} className="bg-white border border-blue-600 text-blue-600 px-6 py-2 rounded-full hover:bg-blue-50 font-bold text-sm transition">Xem th√™m tin c≈© h∆°n</button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const Login = ({ onLoginSuccess }) => {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [error, setError] = useState('');
            const handleLogin = async (e) => { e.preventDefault(); setError(''); try { await signInWithEmailAndPassword(auth, email, password); onLoginSuccess(); } catch (err) { setError('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i.'); } };
            return (
                <div className="max-w-md mx-auto mt-10 bg-white p-8 rounded shadow-lg border-t-4 border-blue-800">
                    <h2 className="text-2xl font-bold text-center mb-6 text-blue-800">ƒêƒÉng nh·∫≠p Qu·∫£n tr·ªã</h2>
                    <form onSubmit={handleLogin} className="space-y-4"><div><label className="block text-gray-700 mb-1">Email</label><input type="email" className="w-full border p-2 rounded" value={email} onChange={e => setEmail(e.target.value)} /></div><div><label className="block text-gray-700 mb-1">M·∫≠t kh·∫©u</label><input type="password" className="w-full border p-2 rounded" value={password} onChange={e => setPassword(e.target.value)} /></div>{error && <p className="text-red-500 text-sm">{error}</p>}<button className="w-full bg-blue-800 text-white py-2 rounded hover:bg-blue-900 font-bold">ƒêƒÉng nh·∫≠p</button></form>
                </div>
            );
        };

        function App() {
            const [currentPage, setCurrentPage] = useState('home');
            const [user, setUser] = useState(null);
            const [skillCategory, setSkillCategory] = useState('G√≥c h·ªçc sinh');
            useEffect(() => { const unsubscribe = onAuthStateChanged(auth, setUser); return () => unsubscribe(); }, []);
            
            const renderContent = () => {
                switch(currentPage) {
                    case 'home': return (<div className="space-y-8"><div className="bg-gradient-to-r from-green-600 to-blue-600 text-white p-8 rounded-xl shadow-lg flex flex-col md:flex-row items-center justify-between"><div className="max-w-2xl"><h2 className="text-3xl font-bold mb-2">C·ªïng tr∆∞·ªùng An to√†n Giao th√¥ng</h2><p className="text-lg opacity-90 mb-4">Chung tay x√¢y d·ª±ng vƒÉn h√≥a giao th√¥ng xanh t·∫°i Ph∆∞·ªùng Th√†nh Sen.</p><button onClick={() => setCurrentPage('map')} className="bg-yellow-400 text-blue-900 px-6 py-2 rounded-full font-bold hover:bg-yellow-300 shadow transition">Xem B·∫£n ƒë·ªì ATGT Ngay</button></div><Shield className="w-32 h-32 opacity-20 md:opacity-40 hidden md:block" /></div><InteractiveMap isAdmin={!!user} /><NewsList categoryFilter={null} /></div>);
                    case 'news': return <NewsList categoryFilter="Tin t·ª©c" />;
                    case 'model': return (<div className="space-y-6"><div className="bg-white p-6 rounded shadow"><h2 className="text-2xl font-bold text-blue-800 mb-4">M√¥ h√¨nh C·ªïng tr∆∞·ªùng ATGT</h2><p className="mb-4 text-gray-700">H·ªá th·ªëng loa tuy√™n truy·ªÅn t·ª± ƒë·ªông ho·∫°t ƒë·ªông v√†o c√°c khung gi·ªù cao ƒëi·ªÉm ƒë·ªÉ nh·∫Øc nh·ªü ph·ª• huynh v√† h·ªçc sinh.</p><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="bg-green-50 p-4 rounded border border-green-200"><h3 className="font-bold text-green-800">Gi·ªù ph√°t thanh S√°ng</h3><p className="text-2xl font-mono text-green-600">6:45 - 7:15</p></div><div className="bg-orange-50 p-4 rounded border border-orange-200"><h3 className="font-bold text-orange-800">Gi·ªù ph√°t thanh Chi·ªÅu</h3><p className="text-2xl font-mono text-orange-600">16:30 - 17:15</p></div></div></div><NewsList categoryFilter="C·ªïng tr∆∞·ªùng" /></div>);
                    case 'skills': return (<div><div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"><div onClick={() => setSkillCategory('G√≥c h·ªçc sinh')} className={`bg-pink-50 p-6 rounded-lg border border-pink-200 text-center cursor-pointer hover:shadow-lg transition ${skillCategory === 'G√≥c h·ªçc sinh' ? 'ring-2 ring-pink-500' : ''}`}><h3 className="text-xl font-bold text-pink-700 mb-2">G√≥c H·ªçc Sinh</h3><p>Video, Infographic k·ªπ nƒÉng ƒëi b·ªô, ƒëi xe ƒë·∫°p an to√†n.</p></div><div onClick={() => setSkillCategory('G√≥c ph·ª• huynh')} className={`bg-indigo-50 p-6 rounded-lg border border-indigo-200 text-center cursor-pointer hover:shadow-lg transition ${skillCategory === 'G√≥c ph·ª• huynh' ? 'ring-2 ring-indigo-500' : ''}`}><h3 className="text-xl font-bold text-indigo-700 mb-2">G√≥c Ph·ª• Huynh</h3><p>H∆∞·ªõng d·∫´n ƒë·ªôi m≈© b·∫£o hi·ªÉm, quy ƒë·ªãnh ƒë∆∞a ƒë√≥n.</p></div></div><NewsList categoryFilter={skillCategory} /></div>);
                    case 'hero': return <NewsList categoryFilter="G∆∞∆°ng ƒëi·ªÉn h√¨nh" />;
                    case 'docs': return (<div className="bg-white p-6 rounded shadow"><h2 className="text-2xl font-bold text-gray-800 mb-6">VƒÉn b·∫£n & Quy ƒë·ªãnh</h2><div className="space-y-4"><div className="flex items-center justify-between p-3 bg-gray-50 rounded border hover:bg-gray-100"><div className="flex items-center gap-3"><FileText className="text-red-500" /><div><p className="font-bold text-gray-800">K·∫ø ho·∫°ch ATGT NƒÉm h·ªçc 2024-2025</p><span className="text-xs text-gray-500">VƒÉn b·∫£n n·ªôi b·ªô ‚Ä¢ 20/08/2024</span></div></div><button className="text-blue-600 text-sm font-bold">T·∫£i v·ªÅ</button></div><div className="flex items-center justify-between p-3 bg-gray-50 rounded border hover:bg-gray-100"><div className="flex items-center gap-3"><FileText className="text-blue-500" /><div><p className="font-bold text-gray-800">M·∫´u cam k·∫øt Ph·ª• huynh - Nh√† tr∆∞·ªùng</p><span className="text-xs text-gray-500">M·∫´u cam k·∫øt ‚Ä¢ 05/09/2024</span></div></div><button className="text-blue-600 text-sm font-bold">T·∫£i v·ªÅ</button></div></div>{user && <AdminDashboard />}</div>);
                    case 'map': return <InteractiveMap isAdmin={!!user} />;
                    case 'login': return <Login onLoginSuccess={() => setCurrentPage('home')} />;
                    case 'admin': return user ? <AdminDashboard /> : <Login onLoginSuccess={() => setCurrentPage('admin')} />;
                    case 'quiz': return <TrafficQuiz />;
                    case 'feedback': return <FeedbackForm />;
                    default: return null;
                }
            };

            return (
                <ErrorBoundary>
                    <div className="min-h-screen bg-slate-100 font-sans text-gray-800">
                        <Header setCurrentPage={setCurrentPage} user={user} onLogout={() => signOut(auth)} />
                        <main className="container mx-auto px-4 py-6">
                            {user && currentPage !== 'login' && (<div className="mb-6 bg-yellow-100 p-3 rounded flex justify-between items-center border border-yellow-300"><span className="text-yellow-800 font-bold text-sm">Xin ch√†o, Admin!</span><button onClick={() => setCurrentPage('admin')} className="text-xs bg-white px-3 py-1 rounded border border-yellow-500 text-yellow-700 font-bold hover:bg-yellow-50">V√†o trang qu·∫£n l√Ω</button></div>)}
                            {renderContent()}
                        </main>
                        <footer className="bg-blue-900 text-white py-8 mt-12"><div className="container mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8 text-sm"><div><h3 className="font-bold text-lg mb-4 uppercase">Tr∆∞·ªùng TH Nam H√†</h3><p className="opacity-80 mb-2">Ph∆∞·ªùng Th√†nh Sen, T·ªânh H√† Tƒ©nh</p></div><div><h3 className="font-bold text-lg mb-4 uppercase">Li√™n k·∫øt</h3><ul className="space-y-2 opacity-80"><li><a href="#" className="hover:text-yellow-400">·ª¶y ban ATGT Qu·ªëc gia</a></li></ul></div><div><h3 className="font-bold text-lg mb-4 uppercase">H·ªó tr·ª£ kh·∫©n c·∫•p</h3><p className="mb-1">C√¥ng an Ph∆∞·ªùng: <span className="font-bold text-yellow-400">0239.xxx.xxx</span></p></div></div><div className="text-center mt-8 pt-4 border-t border-blue-800 opacity-60 text-xs">¬© 2024 Tr∆∞·ªùng Ti·ªÉu h·ªçc Nam H√†.</div></footer>
                    </div>
                </ErrorBoundary>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
